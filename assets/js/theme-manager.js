/**
 * Theme Manager - Управление темами сайта
 * Поддерживает светлую и темную темы с автоматическим сохранением
 */

class ThemeManager {
    constructor() {
        this.themes = {
            dark: 'dark',
            light: 'light'
        };
        
        this.currentTheme = this.getStoredTheme() || this.getSystemTheme();
        this.init();
    }
    
    /**
     * Инициализация менеджера тем
     */
    init() {
        this.applyTheme(this.currentTheme);
        this.bindEvents();
        this.updateThemeButtons();
        
        // Слушаем изменения системной темы
        if (window.matchMedia) {
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
                if (!this.getStoredTheme()) {
                    this.setTheme(e.matches ? this.themes.dark : this.themes.light);
                }
            });
        }
    }
    
    /**
     * Получить сохраненную тему из localStorage
     */
    getStoredTheme() {
        try {
            return localStorage.getItem('vpesports-theme');
        } catch (e) {
            console.warn('LocalStorage недоступен:', e);
            return null;
        }
    }
    
    /**
     * Получить системную тему
     */
    getSystemTheme() {
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            return this.themes.dark;
        }
        return this.themes.dark; // По умолчанию темная тема
    }
    
    /**
     * Сохранить тему в localStorage
     */
    storeTheme(theme) {
        try {
            localStorage.setItem('vpesports-theme', theme);
        } catch (e) {
            console.warn('Не удалось сохранить тему:', e);
        }
    }
    
    /**
     * Применить тему к документу
     */
    applyTheme(theme) {
        // Удаляем все существующие темы
        document.documentElement.removeAttribute('data-theme');
        document.body.classList.remove('theme-dark', 'theme-light');
        
        // Применяем новую тему
        if (theme === this.themes.light) {
            document.documentElement.setAttribute('data-theme', 'light');
            document.body.classList.add('theme-light');
        } else {
            document.documentElement.setAttribute('data-theme', 'dark');
            document.body.classList.add('theme-dark');
        }
        
        this.currentTheme = theme;
        
        // Диспетчеризация события смены темы
        this.dispatchThemeChangeEvent(theme);
    }
    
    /**
     * Установить тему
     */
    setTheme(theme) {
        if (!Object.values(this.themes).includes(theme)) {
            console.warn('Неизвестная тема:', theme);
            return;
        }
        
        this.applyTheme(theme);
        this.storeTheme(theme);
        this.updateThemeButtons();
    }
    
    /**
     * Переключить тему
     */
    toggleTheme() {
        const newTheme = this.currentTheme === this.themes.dark 
            ? this.themes.light 
            : this.themes.dark;
        
        this.setTheme(newTheme);
    }
    
    /**
     * Получить текущую тему
     */
    getCurrentTheme() {
        return this.currentTheme;
    }
    
    /**
     * Проверить, является ли текущая тема темной
     */
    isDarkTheme() {
        return this.currentTheme === this.themes.dark;
    }
    
    /**
     * Проверить, является ли текущая тема светлой
     */
    isLightTheme() {
        return this.currentTheme === this.themes.light;
    }
    
    /**
     * Обновить состояние кнопок переключения темы
     */
    updateThemeButtons() {
        const themeButtons = document.querySelectorAll('[data-theme-toggle]');
        
        themeButtons.forEach(button => {
            // Обновляем иконку в зависимости от текущей темы
            if (this.isDarkTheme()) {
                // Показать иконку солнца (переключить на светлую)
                button.innerHTML = `
                    <svg width="24" height="24" viewBox="0 0 28 28" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M14 2.625C14.2321 2.625 14.4546 2.71719 14.6187 2.88128C14.7828 3.04538 14.875 3.26794 14.875 3.5V6.125C14.875 6.35706 14.7828 6.57962 14.6187 6.74372C14.4546 6.90781 14.2321 7 14 7C13.7679 7 13.5454 6.90781 13.3813 6.74372C13.2172 6.57962 13.125 6.35706 13.125 6.125V3.5C13.125 3.26794 13.2172 3.04538 13.3813 2.88128C13.5454 2.71719 13.7679 2.625 14 2.625ZM8.75 14C8.75 12.6076 9.30312 11.2723 10.2877 10.2877C11.2723 9.30312 12.6076 8.75 14 8.75C15.3924 8.75 16.7277 9.30312 17.7123 10.2877C18.6969 11.2723 19.25 12.6076 19.25 14C19.25 15.3924 18.6969 16.7277 17.7123 17.7123C16.7277 18.6969 15.3924 19.25 14 19.25C12.6076 19.25 11.2723 18.6969 10.2877 17.7123C9.30312 16.7277 8.75 15.3924 8.75 14ZM22.043 7.19367C22.1976 7.0278 22.2817 6.80841 22.2777 6.58172C22.2737 6.35504 22.1819 6.13876 22.0216 5.97844C21.8612 5.81813 21.645 5.7263 21.4183 5.7223C21.1916 5.7183 20.9722 5.80244 20.8063 5.957L18.9502 7.812C18.8666 7.89268 18.7999 7.9892 18.7539 8.09593C18.708 8.20266 18.6838 8.31747 18.6828 8.43365C18.6817 8.54983 18.7038 8.66506 18.7477 8.77261C18.7917 8.88017 18.8566 8.97789 18.9387 9.06009C19.0209 9.14228 19.1185 9.2073 19.226 9.25134C19.3335 9.29539 19.4488 9.31758 19.5649 9.31663C19.6811 9.31568 19.7959 9.29159 19.9027 9.24579C20.0095 9.19998 20.1061 9.13337 20.1868 9.04983L22.043 7.19367ZM25.375 14C25.375 14.2321 25.2828 14.4546 25.1187 14.6187C24.9546 14.7828 24.7321 14.875 24.5 14.875H21.875C21.6429 14.875 21.4204 14.7828 21.2563 14.6187C21.0922 14.4546 21 14.2321 21 14C21 13.7679 21.0922 13.5454 21.2563 13.3813C21.4204 13.2172 21.6429 13.125 21.875 13.125H24.5C24.7321 13.125 24.9546 13.2172 25.1187 13.3813C25.2828 13.5454 25.375 13.7679 25.375 14ZM20.8063 22.043C20.9722 22.1976 21.1916 22.2817 21.4183 22.2777C21.645 22.2737 21.8612 22.1819 22.0216 22.0216C22.1819 21.8612 22.2737 21.645 22.2777 21.4183C22.2817 21.1916 22.1976 20.9722 22.043 20.8063L20.188 18.9502C20.1073 18.8666 20.0108 18.7999 19.9041 18.7539C19.7973 18.708 19.6825 18.6838 19.5664 18.6828C19.4502 18.6817 19.3349 18.7038 19.2274 18.7477C19.1198 18.7917 19.0221 18.8566 18.9399 18.9387C18.8577 19.0209 18.7927 19.1185 18.7487 19.226C18.7046 19.3335 18.6824 19.4488 18.6834 19.5649C18.6843 19.6811 18.7084 19.7959 18.7542 19.9027C18.8 20.0095 18.8666 20.1061 18.9502 20.1868L20.8063 22.043ZM14 21C14.2321 21 14.4546 21.0922 14.6187 21.2563C14.7828 21.4204 14.875 21.6429 14.875 21.875V24.5C14.875 24.7321 14.7828 24.9546 14.6187 25.1187C14.4546 25.2828 14.2321 25.375 14 25.375C13.7679 25.375 13.5454 25.2828 13.3813 25.1187C13.2172 24.9546 13.125 24.7321 13.125 24.5V21.875C13.125 21.6429 13.2172 21.4204 13.3813 21.2563C13.5454 21.0922 13.7679 21 14 21ZM9.051 20.1868C9.21031 20.0217 9.2984 19.8007 9.2963 19.5712C9.2942 19.3418 9.20208 19.1224 9.03977 18.9602C8.87746 18.7981 8.65795 18.7062 8.42853 18.7043C8.1991 18.7024 7.97812 18.7907 7.81317 18.9502L5.957 20.8052C5.79753 20.9701 5.70923 21.1911 5.71112 21.4205C5.713 21.65 5.80492 21.8695 5.96708 22.0318C6.12923 22.1941 6.34865 22.2862 6.57807 22.2883C6.8075 22.2904 7.02856 22.2023 7.19367 22.043L9.04983 20.188L9.051 20.1868ZM7 14C7 14.2321 6.90781 14.4546 6.74372 14.6187C6.57962 14.7828 6.35706 14.875 6.125 14.875H3.5C3.26794 14.875 3.04538 14.7828 2.88128 14.6187C2.71719 14.4546 2.625 14.2321 2.625 14C2.625 13.7679 2.71719 13.5454 2.88128 13.3813C3.04538 13.2172 3.26794 13.125 3.5 13.125H6.125C6.35706 13.125 6.57962 13.2172 6.74372 13.3813C6.90781 13.5454 7 13.7679 7 14ZM7.81317 9.04983C7.97904 9.20439 8.19842 9.28854 8.42511 9.28454C8.65179 9.28054 8.86808 9.18871 9.02839 9.02839C9.18871 8.86808 9.28054 8.65179 9.28454 8.42511C9.28854 8.19842 9.20439 7.97904 9.04983 7.81317L7.19483 5.957C7.02988 5.79753 6.8089 5.70923 6.57947 5.71112C6.35005 5.713 6.13054 5.80492 5.96823 5.96708C5.80592 6.12923 5.7138 6.34865 5.7117 6.57807C5.7096 6.8075 5.79769 7.02856 5.957 7.19367L7.81317 9.04983Z" fill="currentColor"/>
                    </svg>
                `;
                button.title = 'Переключить на светлую тему';
            } else {
                // Показать иконку луны (переключить на темную)
                button.innerHTML = `
                    <svg width="24" height="24" viewBox="0 0 28 28" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M25.0625 14.875C24.8899 17.0497 24.1086 19.1286 22.8234 20.8616C21.5382 22.5946 19.8095 23.9088 17.8427 24.6439C15.876 25.379 13.7486 25.5044 11.7073 25.0065C9.66606 24.5086 7.79911 23.4086 6.33663 21.846C4.87414 20.2834 3.87753 18.3464 3.38323 16.2351C2.88893 14.1239 3.01774 11.9265 3.75618 9.89008C4.49462 7.85365 5.81203 6.05507 7.54831 4.70023C9.28459 3.34539 11.4235 2.49408 13.6675 2.25875C13.4322 3.08235 13.3609 3.94714 13.4581 4.80037C13.5553 5.6536 13.8191 6.4795 14.2345 7.23059C14.6498 7.98169 15.2085 8.64343 15.8772 9.17959C16.5459 9.71575 17.3117 10.1147 18.1299 10.3545C18.9481 10.5943 19.8034 10.6705 20.6516 10.5793C21.4998 10.4881 22.3257 10.2314 23.0825 9.82375C22.6949 11.6806 21.7622 13.3846 20.4057 14.7411C19.0492 16.0976 17.3452 17.0303 15.4884 17.4179C15.7336 18.1718 16.1426 18.8639 16.6866 19.4454C17.2306 20.0269 17.8959 20.4829 18.6367 20.7813C19.3775 21.0797 20.1748 21.2127 20.9714 21.1713C21.768 21.1299 22.5455 20.9152 23.2475 20.5425C22.5455 21.9152 21.768 22.6299 20.9714 22.6713C20.1748 22.7127 19.3775 22.5797 18.6367 22.2813C17.8959 21.9829 17.2306 21.5269 16.6866 20.9454C16.1426 20.3639 15.7336 19.6718 15.4884 18.9179C17.3452 18.5303 19.0492 17.5976 20.4057 16.2411C21.7622 14.8846 22.6949 13.1806 23.0825 11.3238C23.3257 11.7314 23.4998 12.1881 23.6516 12.6793C23.8034 13.1705 23.9481 13.6943 24.1299 14.2545C24.3117 14.8147 24.5459 15.3575 24.8772 15.8796C25.2085 16.4017 25.6498 16.8832 26.2345 17.3306C26.8191 17.778 27.4799 18.1498 28.1675 18.4238C27.4235 18.5908 26.6536 18.6553 25.8899 18.6247C25.1322 18.5941 24.3899 18.4682 23.6675 18.25C23.9086 17.1286 24.1382 15.9946 24.8234 14.8616C25.5086 13.7286 25.8899 12.5497 25.0625 14.875Z" fill="currentColor"/>
                    </svg>
                `;
                button.title = 'Переключить на темную тему';
            }
        });
    }
    
    /**
     * Привязать события
     */
    bindEvents() {
        // Находим все кнопки переключения темы
        document.addEventListener('click', (e) => {
            if (e.target.closest('[data-theme-toggle]')) {
                e.preventDefault();
                this.toggleTheme();
            }
        });
        
        // Поддержка клавиатурных сочетаний (Ctrl+Shift+T)
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.shiftKey && e.key === 'T') {
                e.preventDefault();
                this.toggleTheme();
            }
        });
    }
    
    /**
     * Диспетчеризация события смены темы
     */
    dispatchThemeChangeEvent(theme) {
        const event = new CustomEvent('themeChanged', {
            detail: {
                theme: theme,
                isDark: theme === this.themes.dark,
                isLight: theme === this.themes.light
            }
        });
        
        document.dispatchEvent(event);
    }
    
    /**
     * Статический метод для быстрого доступа к менеджеру тем
     */
    static getInstance() {
        if (!window.themeManager) {
            window.themeManager = new ThemeManager();
        }
        return window.themeManager;
    }
}

// Автоматическая инициализация при загрузке DOM
document.addEventListener('DOMContentLoaded', () => {
    window.themeManager = new ThemeManager();
});

// Экспорт для использования в других скриптах
if (typeof module !== 'undefined' && module.exports) {
    module.exports = ThemeManager;
}
